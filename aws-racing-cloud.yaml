AWSTemplateFormatVersion: '2010-09-09'
Description: |
  Racing Santander - Infraestructura Alta Disponibilidad
  Componentes: ALB + ASG WordPress + RDS Multi-AZ + EFS + VPN WireGuard + Zabbix
  Compatible con AWS Academy Lab

# ============================================================
# PARAMETROS DE ENTRADA
# ============================================================
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Configuración General"
        Parameters:
          - KeyName
          - DBPassword
      - Label:
          default: "Auto Scaling WordPress"
        Parameters:
          - WordPressMinSize
          - WordPressMaxSize
      - Label:
          default: "VPN WireGuard (Opcional)"
        Parameters:
          - WireGuardServerPublicKey
          - WireGuardPeerEndpoint

Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Default: vockey
    Description: Par de claves SSH para acceso a instancias

  DBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Default: Racing2026
    Description: Contraseña para RDS MariaDB y Zabbix

  WordPressMinSize:
    Type: Number
    Default: 2
    MinValue: 1
    MaxValue: 4
    Description: Número mínimo de instancias WordPress en ASG

  WordPressMaxSize:
    Type: Number
    Default: 4
    MinValue: 2
    MaxValue: 10
    Description: Número máximo de instancias WordPress en ASG

  WireGuardServerPublicKey:
    Type: String
    Default: "PLACEHOLDER_PUBLIC_KEY"
    Description: Clave pública del servidor WireGuard físico del estadio

  WireGuardPeerEndpoint:
    Type: String
    Default: "0.0.0.0:51820"
    Description: IP pública del servidor WireGuard físico (formato IP:PUERTO)

# ============================================================
# RECURSOS
# ============================================================
Resources:

  # ============================================================
  # RED - VPC Y SUBNETS
  # ============================================================
  
  RacingVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.200.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: Racing-VPC
        - Key: Proyecto
          Value: Racing-Santander

  RacingInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: Racing-IGW

  RacingIGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref RacingVPC
      InternetGatewayId: !Ref RacingInternetGateway

  # --- SUBNETS PUBLICAS (Load Balancer + Bastion) ---
  
  RacingPublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RacingVPC
      CidrBlock: 10.200.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Racing-Public-Subnet-AZ1

  RacingPublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RacingVPC
      CidrBlock: 10.200.11.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Racing-Public-Subnet-AZ2

  # --- SUBNETS PRIVADAS (WordPress + RDS + Zabbix + EFS) ---
  
  RacingPrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RacingVPC
      CidrBlock: 10.200.20.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: Racing-Private-Subnet-AZ1

  RacingPrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RacingVPC
      CidrBlock: 10.200.21.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: Racing-Private-Subnet-AZ2

  # --- NAT GATEWAYS (Alta Disponibilidad) ---
  
  RacingNATGatewayEIPA:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: Racing-NAT-EIP-AZ1

  RacingNATGatewayEIPB:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: Racing-NAT-EIP-AZ2

  RacingNATGatewayA:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt RacingNATGatewayEIPA.AllocationId
      SubnetId: !Ref RacingPublicSubnetA
      Tags:
        - Key: Name
          Value: Racing-NAT-Gateway-AZ1

  RacingNATGatewayB:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt RacingNATGatewayEIPB.AllocationId
      SubnetId: !Ref RacingPublicSubnetB
      Tags:
        - Key: Name
          Value: Racing-NAT-Gateway-AZ2

  # --- TABLAS DE RUTAS ---
  
  RacingPublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-Public-RouteTable

  RacingPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: RacingIGWAttachment
    Properties:
      RouteTableId: !Ref RacingPublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref RacingInternetGateway

  RacingPublicSubnetARouteAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RacingPublicSubnetA
      RouteTableId: !Ref RacingPublicRouteTable

  RacingPublicSubnetBRouteAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RacingPublicSubnetB
      RouteTableId: !Ref RacingPublicRouteTable

  RacingPrivateRouteTableA:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-Private-RouteTable-AZ1

  RacingPrivateRouteTableB:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-Private-RouteTable-AZ2

  RacingPrivateRouteA:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RacingPrivateRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref RacingNATGatewayA

  RacingPrivateRouteB:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RacingPrivateRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref RacingNATGatewayB

  RacingPrivateSubnetARouteAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RacingPrivateSubnetA
      RouteTableId: !Ref RacingPrivateRouteTableA

  RacingPrivateSubnetBRouteAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RacingPrivateSubnetB
      RouteTableId: !Ref RacingPrivateRouteTableB

  # ============================================================
  # SECURITY GROUPS
  # ============================================================
  
  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-LoadBalancer-SG
      GroupDescription: Permite HTTP público al Load Balancer
      VpcId: !Ref RacingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP desde Internet
      Tags:
        - Key: Name
          Value: Racing-LoadBalancer-SG

  BastionSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-Bastion-SG
      GroupDescription: SSH y WireGuard VPN para Bastion
      VpcId: !Ref RacingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: SSH desde Internet
        - IpProtocol: udp
          FromPort: 51820
          ToPort: 51820
          CidrIp: 0.0.0.0/0
          Description: WireGuard VPN desde terminales estadio
      Tags:
        - Key: Name
          Value: Racing-Bastion-SG

  WordPressSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-WordPress-SG
      GroupDescription: Permite HTTP desde ALB, SSH desde Bastion y NFS a EFS
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-WordPress-SG

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-Database-SG
      GroupDescription: MySQL desde WordPress, Bastion y VPN
      VpcId: !Ref RacingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.200.20.0/23
          Description: MySQL desde subnets privadas WordPress
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: MySQL desde Bastion para administración
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.200.99.0/24
          Description: MySQL desde red VPN WireGuard terminales
      Tags:
        - Key: Name
          Value: Racing-Database-SG

  EFSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-EFS-SG
      GroupDescription: NFS para EFS desde instancias WordPress
      VpcId: !Ref RacingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !Ref WordPressSecurityGroup
          Description: NFS desde WordPress para wp-content compartido
      Tags:
        - Key: Name
          Value: Racing-EFS-SG

  MonitoringSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-Monitoring-SG
      GroupDescription: Zabbix Server HTTP y agentes
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-Monitoring-SG

  # --- REGLAS DE INGRESO SEPARADAS (Evitan referencias circulares) ---
  
  WordPressIngressFromALB:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref WordPressSecurityGroup
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80
      SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup
      Description: HTTP solo desde Load Balancer

  WordPressIngressFromBastion:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref WordPressSecurityGroup
      IpProtocol: tcp
      FromPort: 22
      ToPort: 22
      SourceSecurityGroupId: !Ref BastionSecurityGroup
      Description: SSH solo desde Bastion

  MonitoringIngressHTTP:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref MonitoringSecurityGroup
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80
      SourceSecurityGroupId: !Ref BastionSecurityGroup
      Description: HTTP Zabbix Web desde Bastion

  MonitoringIngressSSH:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref MonitoringSecurityGroup
      IpProtocol: tcp
      FromPort: 22
      ToPort: 22
      SourceSecurityGroupId: !Ref BastionSecurityGroup
      Description: SSH desde Bastion

  MonitoringIngressZabbix:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref MonitoringSecurityGroup
      IpProtocol: tcp
      FromPort: 10051
      ToPort: 10051
      SourceSecurityGroupId: !Ref WordPressSecurityGroup
      Description: Zabbix Trapper desde WordPress

  # ============================================================
  # EFS - SISTEMA DE ARCHIVOS COMPARTIDO PARA WP-CONTENT
  # ============================================================
  
  WordPressEFS:
    Type: AWS::EFS::FileSystem
    Properties:
      Encrypted: true
      PerformanceMode: generalPurpose
      ThroughputMode: bursting
      BackupPolicy:
        Status: ENABLED
      LifecyclePolicies:
        - TransitionToIA: AFTER_30_DAYS
      FileSystemTags:
        - Key: Name
          Value: Racing-WordPress-EFS
        - Key: Proyecto
          Value: Racing-Santander

  EFSMountTargetA:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref WordPressEFS
      SubnetId: !Ref RacingPrivateSubnetA
      SecurityGroups:
        - !Ref EFSSecurityGroup

  EFSMountTargetB:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref WordPressEFS
      SubnetId: !Ref RacingPrivateSubnetB
      SecurityGroups:
        - !Ref EFSSecurityGroup

  # ============================================================
  # RDS - BASE DE DATOS MARIADB MULTI-AZ
  # ============================================================
  
  RacingDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: racing-database-subnet-group
      DBSubnetGroupDescription: Subnets privadas para RDS Multi-AZ
      SubnetIds:
        - !Ref RacingPrivateSubnetA
        - !Ref RacingPrivateSubnetB
      Tags:
        - Key: Name
          Value: Racing-Database-SubnetGroup

  RacingMariaDBInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: racing-mariadb
      Engine: mariadb
      EngineVersion: '10.11'
      DBInstanceClass: db.t3.micro
      AllocatedStorage: 20
      StorageType: gp3
      MasterUsername: admin
      MasterUserPassword: !Ref DBPassword
      DBName: estadio_racing_bares
      DBSubnetGroupName: !Ref RacingDBSubnetGroup
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      PubliclyAccessible: false
      BackupRetentionPeriod: 7
      PreferredBackupWindow: '03:00-04:00'
      PreferredMaintenanceWindow: 'sun:04:00-sun:05:00'
      MultiAZ: true
      CopyTagsToSnapshot: true
      Tags:
        - Key: Name
          Value: Racing-MariaDB-Instance
        - Key: Backup
          Value: Automated

  # ============================================================
  # APPLICATION LOAD BALANCER
  # ============================================================
  
  RacingLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: Racing-ALB
      Type: application
      Scheme: internet-facing
      IpAddressType: ipv4
      Subnets:
        - !Ref RacingPublicSubnetA
        - !Ref RacingPublicSubnetB
      SecurityGroups:
        - !Ref LoadBalancerSecurityGroup
      Tags:
        - Key: Name
          Value: Racing-Application-LoadBalancer

  WordPressTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: Racing-WordPress-Targets
      VpcId: !Ref RacingVPC
      Protocol: HTTP
      Port: 80
      TargetType: instance
      HealthCheckEnabled: true
      HealthCheckProtocol: HTTP
      HealthCheckPath: /wp-admin/install.php
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: '200,301,302'
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: '30'
      Tags:
        - Key: Name
          Value: Racing-WordPress-TargetGroup

  LoadBalancerListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref RacingLoadBalancer
      Protocol: HTTP
      Port: 80
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref WordPressTargetGroup

  # ============================================================
  # WORDPRESS - LAUNCH TEMPLATE + AUTO SCALING GROUP
  # ============================================================
  
  WordPressLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    DependsOn:
      - RacingMariaDBInstance
      - WordPressEFS
      - EFSMountTargetA
      - EFSMountTargetB
    Properties:
      LaunchTemplateName: Racing-WordPress-LaunchTemplate
      LaunchTemplateData:
        ImageId: ami-0e86e20dae9224db8  # Ubuntu 24.04 LTS (us-east-1) - CAMBIAR SEGÚN REGIÓN
        InstanceType: t3.small
        KeyName: !Ref KeyName
        IamInstanceProfile:
          Name: LabInstanceProfile
        SecurityGroupIds:
          - !Ref WordPressSecurityGroup
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: Racing-WordPress-Instance
              - Key: ManagedBy
                Value: AutoScaling
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            set -e
            exec > >(tee /var/log/wordpress-setup.log)
            exec 2>&1
            
            echo "=== INSTALACION WORDPRESS + EFS RACING SANTANDER ==="
            echo "Timestamp: $(date)"
            
            # 1/12 Actualizar sistema
            echo "[1/12] Actualizando Ubuntu 24.04..."
            apt-get update -y
            DEBIAN_FRONTEND=noninteractive apt-get upgrade -y
            
            # 2/12 Instalar Apache, PHP, MySQL, NFS
            echo "[2/12] Instalando Apache, PHP 8.3, MySQL client, NFS..."
            apt-get install -y apache2 php libapache2-mod-php php-mysql php-gd php-xml php-mbstring php-curl php-zip wget nfs-common awscli
            
            # 3/12 Configurar PHP para uploads grandes
            echo "[3/12] Configurando PHP para archivos grandes..."
            sed -i 's/upload_max_filesize = 2M/upload_max_filesize = 512M/' /etc/php/*/apache2/php.ini
            sed -i 's/post_max_size = 8M/post_max_size = 512M/' /etc/php/*/apache2/php.ini
            sed -i 's/max_execution_time = 30/max_execution_time = 300/' /etc/php/*/apache2/php.ini
            sed -i 's/memory_limit = 128M/memory_limit = 256M/' /etc/php/*/apache2/php.ini
            
            # 4/12 Descargar WordPress
            echo "[4/12] Descargando WordPress..."
            cd /var/www/html
            rm -f index.html
            wget -q https://wordpress.org/latest.tar.gz
            tar -xzf latest.tar.gz --strip-components=1
            rm latest.tar.gz
            
            # 5/12 Preparar wp-content para montar EFS
            echo "[5/12] Preparando directorio wp-content temporal..."
            mkdir -p /tmp/wp-content-backup
            mv /var/www/html/wp-content/* /tmp/wp-content-backup/ 2>/dev/null || true
            rm -rf /var/www/html/wp-content
            
            # 6/12 Montar EFS en wp-content (compartido entre instancias)
            echo "[6/12] Montando EFS en /var/www/html/wp-content..."
            mkdir -p /var/www/html/wp-content
            echo "${WordPressEFS}.efs.${AWS::Region}.amazonaws.com:/ /var/www/html/wp-content nfs4 nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport,_netdev 0 0" >> /etc/fstab
            mount -a -t nfs4
            
            # 7/12 Restaurar archivos WordPress si es la primera instancia
            echo "[7/12] Verificando contenido de EFS..."
            if [ ! "$(ls -A /var/www/html/wp-content)" ]; then
              echo "  → Primera instancia detectada. Copiando archivos WordPress a EFS..."
              cp -r /tmp/wp-content-backup/* /var/www/html/wp-content/
            else
              echo "  → EFS ya contiene archivos. Saltando copia inicial."
            fi
            rm -rf /tmp/wp-content-backup
            
            # 8/12 Obtener DNS del Load Balancer dinámicamente
            echo "[8/12] Obteniendo DNS del Load Balancer..."
            ALB_DNS=""
            for i in {1..20}; do
              ALB_DNS=$(aws elbv2 describe-load-balancers --names Racing-ALB --query 'LoadBalancers[0].DNSName' --output text --region ${AWS::Region} 2>/dev/null || echo "")
              if [ -n "$ALB_DNS" ] && [ "$ALB_DNS" != "None" ]; then
                echo "  ✓ ALB DNS encontrado: $ALB_DNS"
                break
              fi
              echo "  → Intento $i/20 fallido. Reintentando en 10s..."
              sleep 10
            done
            
            if [ -z "$ALB_DNS" ] || [ "$ALB_DNS" == "None" ]; then
              ALB_DNS="racing-alb.${AWS::Region}.elb.amazonaws.com"
              echo "  ⚠ ADVERTENCIA: Usando DNS por defecto: $ALB_DNS"
            fi
            
            # 9/12 Crear wp-config.php
            echo "[9/12] Creando wp-config.php..."
            cp wp-config-sample.php wp-config.php
            sed -i "s/database_name_here/estadio_racing_bares/" wp-config.php
            sed -i "s/username_here/admin/" wp-config.php
            sed -i "s/password_here/${DBPassword}/" wp-config.php
            sed -i "s/localhost/${RacingMariaDBInstance.Endpoint.Address}/" wp-config.php
            
            # 10/12 Configurar soporte para Load Balancer (Reverse Proxy)
            echo "[10/12] Configurando soporte para ALB..."
            cat >> wp-config.php <<'WPCONF'
            
            /* ========================================
               CONFIGURACION LOAD BALANCER REVERSE PROXY
               ======================================== */
            if (isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
                $_SERVER['HTTPS'] = 'on';
            }
            if (isset($_SERVER['HTTP_X_FORWARDED_HOST'])) {
                $_SERVER['HTTP_HOST'] = $_SERVER['HTTP_X_FORWARDED_HOST'];
            }
            WPCONF
            
            sed -i "/That's all, stop editing/i define('WP_HOME', 'http://$ALB_DNS');" wp-config.php
            sed -i "/That's all, stop editing/i define('WP_SITEURL', 'http://$ALB_DNS');" wp-config.php
            
            # 11/12 Ajustar permisos para Apache
            echo "[11/12] Ajustando permisos..."
            chown -R www-data:www-data /var/www/html
            chmod -R 755 /var/www/html
            find /var/www/html -type f -exec chmod 644 {} \;
            
            # 12/12 Configurar y arrancar Apache
            echo "[12/12] Configurando Apache..."
            echo "ServerName localhost" >> /etc/apache2/apache2.conf
            a2enmod rewrite
            systemctl enable apache2
            systemctl restart apache2
            
            echo "=== WORDPRESS + EFS INSTALADO CORRECTAMENTE ==="
            echo "EFS FileSystem: ${WordPressEFS}"
            echo "Timestamp: $(date)"

  WordPressAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    DependsOn:
      - RacingMariaDBInstance
      - WordPressTargetGroup
      - WordPressEFS
    Properties:
      AutoScalingGroupName: Racing-WordPress-ASG
      VPCZoneIdentifier:
        - !Ref RacingPrivateSubnetA
        - !Ref RacingPrivateSubnetB
      LaunchTemplate:
        LaunchTemplateId: !Ref WordPressLaunchTemplate
        Version: !GetAtt WordPressLaunchTemplate.LatestVersionNumber
      MinSize: !Ref WordPressMinSize
      MaxSize: !Ref WordPressMaxSize
      DesiredCapacity: !Ref WordPressMinSize
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      TargetGroupARNs:
        - !Ref WordPressTargetGroup
      Tags:
        - Key: Name
          Value: Racing-WordPress-ASG-Instance
          PropagateAtLaunch: true
        - Key: Proyecto
          Value: Racing-Santander
          PropagateAtLaunch: true

  WordPressScalingPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref WordPressAutoScalingGroup
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization
        TargetValue: 70.0

  # ============================================================
  # BASTION HOST + VPN WIREGUARD + IMPORTACION SQL
  # ============================================================
  
  BastionVPNHost:
    Type: AWS::EC2::Instance
    DependsOn: RacingMariaDBInstance
    Properties:
      InstanceType: t3.small
      ImageId: ami-0e86e20dae9224db8  # Ubuntu 24.04 LTS (us-east-1) - CAMBIAR SEGÚN REGIÓN
      KeyName: !Ref KeyName
      SubnetId: !Ref RacingPublicSubnetA
      SecurityGroupIds:
        - !Ref BastionSecurityGroup
      IamInstanceProfile: LabInstanceProfile
      SourceDestCheck: false  # Necesario para VPN
      Tags:
        - Key: Name
          Value: Racing-Bastion-VPN
        - Key: Rol
          Value: SSH-Jumpbox-WireGuard-VPN-SQLImporter
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/bastion-setup.log)
          exec 2>&1
          
          echo "=========================================="
          echo "BASTION + WIREGUARD VPN + IMPORTACION SQL"
          echo "=========================================="
          echo "Timestamp: $(date)"
          
          # 1/5 Actualizar sistema e instalar paquetes
          echo "[1/5] Actualizando Ubuntu 24.04..."
          apt-get update -y
          DEBIAN_FRONTEND=noninteractive apt-get upgrade -y
          
          echo "[2/5] Instalando herramientas administrativas..."
          apt-get install -y mysql-client wget curl vim htop tcpdump nmap net-tools wireguard iptables-persistent
          
          # 2/5 Configurar WireGuard VPN
          echo "[3/5] Configurando WireGuard VPN..."
          cd /etc/wireguard
          wg genkey | tee privatekey | wg pubkey > publickey
          chmod 600 privatekey
          PRIVATE_KEY=$(cat privatekey)
          PUBLIC_KEY=$(cat publickey)
          
          echo ""
          echo "============================================"
          echo "CLAVE PUBLICA WIREGUARD (COMPARTIR CON SERVIDOR FISICO):"
          echo "$PUBLIC_KEY"
          echo "============================================"
          echo ""
          echo "$PUBLIC_KEY" > /tmp/wireguard-public-key.txt
          
          cat > /etc/wireguard/wg0.conf <<WGEOF
          [Interface]
          Address = 10.200.99.1/24
          ListenPort = 51820
          PrivateKey = $PRIVATE_KEY
          
          # Habilitar IP Forwarding y NAT
          PostUp = sysctl -w net.ipv4.ip_forward=1
          PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
          PostUp = iptables -t nat -A POSTROUTING -o ens5 -j MASQUERADE
          PostDown = iptables -D FORWARD -i wg0 -j ACCEPT
          PostDown = iptables -t nat -D POSTROUTING -o ens5 -j MASQUERADE
          
          [Peer]
          PublicKey = ${WireGuardServerPublicKey}
          Endpoint = ${WireGuardPeerEndpoint}
          AllowedIPs = 10.200.99.0/24
          PersistentKeepalive = 25
          WGEOF
          
          chmod 600 /etc/wireguard/wg0.conf
          
          # Habilitar IP Forwarding permanente
          echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
          sysctl -p
          
          # Iniciar WireGuard
          systemctl enable wg-quick@wg0
          systemctl start wg-quick@wg0
          
          echo "[4/5] WireGuard VPN configurado correctamente:"
          wg show
          
          # 3/5 IMPORTAR SQL A RDS
          echo ""
          echo "=========================================="
          echo "[5/5] IMPORTANDO BASE DE DATOS A RDS..."
          echo "=========================================="
          
          RDS_HOST="${RacingMariaDBInstance.Endpoint.Address}"
          RDS_USER="admin"
          RDS_PASS="${DBPassword}"
          RDS_DB="estadio_racing_bares"
          
          echo "→ Endpoint RDS: $RDS_HOST"
          echo "→ Base de Datos: $RDS_DB"
          
          # Esperar a que RDS esté disponible (hasta 5 minutos)
          echo "→ Esperando a que RDS esté disponible..."
          for i in {1..30}; do
            if mysql -h $RDS_HOST -u $RDS_USER -p$RDS_PASS -e "SELECT 1" > /dev/null 2>&1; then
              echo "  ✓ RDS disponible (intento $i/30)"
              break
            fi
            echo "  → Intento $i/30 fallido. Reintentando en 10s..."
            sleep 10
          done
          
          # Descargar SQL desde GitHub
          echo "→ Descargando SQL desde GitHub..."
          wget -O /tmp/estadio.sql https://raw.githubusercontent.com/sleuzau01/ASIR-Reto-Equipo3/main/estadio_racing_bares.sql
          
          if [ ! -f /tmp/estadio.sql ]; then
            echo "✗ ERROR: No se pudo descargar el archivo SQL"
            exit 1
          fi
          
          # Importar SQL a RDS
          echo "→ Importando SQL a RDS..."
          mysql -h $RDS_HOST -u $RDS_USER -p$RDS_PASS $RDS_DB < /tmp/estadio.sql
          
          if [ $? -eq 0 ]; then
            echo "  ✓ Importación completada exitosamente"
          else
            echo "  ✗ ERROR en la importación"
            exit 1
          fi
          
          # Verificar datos importados
          echo "→ Verificando datos importados..."
          mysql -h $RDS_HOST -u $RDS_USER -p$RDS_PASS -e "USE $RDS_DB; SHOW TABLES;"
          mysql -h $RDS_HOST -u $RDS_USER -p$RDS_PASS -e "USE $RDS_DB; SELECT COUNT(*) AS total_bares FROM bares;"
          
          # Limpiar archivo temporal
          rm -f /tmp/estadio.sql
          
          echo ""
          echo "=========================================="
          echo "✓ BASTION + VPN + SQL IMPORT COMPLETADO"
          echo "=========================================="
          echo "Timestamp: $(date)"
          echo ""
          echo "Clave pública WireGuard guardada en: /tmp/wireguard-public-key.txt"
          echo "Ejecutar: cat /tmp/wireguard-public-key.txt"

  # ============================================================
  # ZABBIX MONITORING SERVER
  # ============================================================
  
  ZabbixMonitoringServer:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.medium
      ImageId: ami-0e86e20dae9224db8  # Ubuntu 24.04 LTS (us-east-1) - CAMBIAR SEGÚN REGIÓN
      KeyName: !Ref KeyName
      SubnetId: !Ref RacingPrivateSubnetA
      SecurityGroupIds:
        - !Ref MonitoringSecurityGroup
      IamInstanceProfile: LabInstanceProfile
      Tags:
        - Key: Name
          Value: Racing-Zabbix-Server
        - Key: Rol
          Value: Monitoring
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/zabbix-setup.log)
          exec 2>&1
          
          echo "=== INSTALACION ZABBIX SERVER 7.0 LTS ==="
          echo "Timestamp: $(date)"
          
          # Actualizar sistema
          apt-get update -y
          DEBIAN_FRONTEND=noninteractive apt-get upgrade -y
          
          # Instalar repositorio Zabbix 7.0 para Ubuntu 24.04
          echo "[1/5] Instalando repositorio Zabbix 7.0..."
          wget https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_7.0+ubuntu24.04_all.deb
          dpkg -i zabbix-release_latest_7.0+ubuntu24.04_all.deb
          apt-get update -y
          
          # Instalar componentes Zabbix
          echo "[2/5] Instalando Zabbix Server, Frontend, Agent..."
          DEBIAN_FRONTEND=noninteractive apt-get install -y zabbix-server-mysql zabbix-frontend-php zabbix-apache-conf zabbix-sql-scripts zabbix-agent mysql-server
          
          # Configurar MySQL
          echo "[3/5] Configurando base de datos MySQL..."
          systemctl start mysql
          systemctl enable mysql
          
          # Crear base de datos y usuario Zabbix
          mysql -e "CREATE DATABASE zabbix CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;"
          mysql -e "CREATE USER 'zabbix'@'localhost' IDENTIFIED BY '${DBPassword}';"
          mysql -e "GRANT ALL PRIVILEGES ON zabbix.* TO 'zabbix'@'localhost';"
          mysql -e "SET GLOBAL log_bin_trust_function_creators = 1;"
          
          # Importar esquema Zabbix
          echo "[4/5] Importando esquema de base de datos Zabbix..."
          zcat /usr/share/zabbix-sql-scripts/mysql/server.sql.gz | mysql --default-character-set=utf8mb4 -uzabbix -p${DBPassword} zabbix
          
          mysql -e "SET GLOBAL log_bin_trust_function_creators = 0;"
          
          # Configurar Zabbix Server
          sed -i "s/# DBPassword=/DBPassword=${DBPassword}/" /etc/zabbix/zabbix_server.conf
          
          # Configurar zona horaria PHP
          sed -i "s/; php_value date.timezone Europe\/Riga/php_value date.timezone Europe\/Madrid/" /etc/apache2/conf-enabled/zabbix.conf
          
          # Iniciar servicios
          echo "[5/5] Iniciando servicios Zabbix..."
          systemctl restart zabbix-server zabbix-agent apache2
          systemctl enable zabbix-server zabbix-agent apache2
          
          echo "=== ZABBIX INSTALADO CORRECTAMENTE ==="
          echo "Acceso Web: http://$(hostname -I | awk '{print $1}')/zabbix"
          echo "Usuario por defecto: Admin"
          echo "Contraseña por defecto: zabbix"
          echo "Timestamp: $(date)"

# ============================================================
# OUTPUTS - INFORMACIÓN DE ACCESO
# ============================================================

Outputs:
  WebsiteURL:
    Description: URL PRINCIPAL - WordPress Racing Santander
    Value: !Sub 'http://${RacingLoadBalancer.DNSName}'
    Export:
      Name: !Sub '${AWS::StackName}-Website-URL'

  WordPressAdminURL:
    Description: Panel de Administración WordPress
    Value: !Sub 'http://${RacingLoadBalancer.DNSName}/wp-admin'

  BastionSSHCommand:
    Description: Comando SSH para conectar al Bastion
    Value: !Sub 'ssh -i vockey.pem ubuntu@${BastionVPNHost.PublicIp}'

  WireGuardPublicKeyLocation:
    Description: Ubicación de la Clave Pública WireGuard
    Value: 'Ejecutar en Bastion: cat /tmp/wireguard-public-key.txt'

  DatabaseEndpoint:
    Description: Endpoint de la Base de Datos MariaDB
    Value: !GetAtt RacingMariaDBInstance.Endpoint.Address

  DatabaseConnectionCommand:
    Description: Comando para conectar a la Base de Datos desde Bastion
    Value: !Sub 'mysql -h ${RacingMariaDBInstance.Endpoint.Address} -u admin -p${DBPassword} estadio_racing_bares'

  EFSFileSystemID:
    Description: ID del Sistema de Archivos EFS para wp-content
    Value: !Ref WordPressEFS
    Export:
      Name: !Sub '${AWS::StackName}-EFS-ID'

  EFSMountCommand:
    Description: Comando para montar EFS manualmente
    Value: !Sub 'sudo mount -t nfs4 -o nfsvers=4.1 ${WordPressEFS}.efs.${AWS::Region}.amazonaws.com:/ /mnt/efs'

  ZabbixAccessTunnel:
    Description: Túnel SSH para acceder a Zabbix Web
    Value: !Sub 'ssh -i vockey.pem -L 8080:${ZabbixMonitoringServer.PrivateIp}:80 ubuntu@${BastionVPNHost.PublicIp}'

  VPNNetworkInfo:
    Description: Red VPN WireGuard
    Value: '10.200.99.0/24 | AWS: 10.200.99.1 | Clientes: 10.200.99.2-254'

  AutoScalingGroupName:
    Description: Nombre del Auto Scaling Group de WordPress
    Value: !Ref WordPressAutoScalingGroup