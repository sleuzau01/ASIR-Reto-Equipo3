AWSTemplateFormatVersion: '2010-09-09'

Description: |
  Racing Santander - Infraestructura HA con EFS para WordPress Ãšnico
  Componentes: ALB + ASG WordPress + RDS Multi-AZ + EFS + VPN WireGuard + Nginx + Zabbix
  Compatible con AWS Academy Lab

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label: {default: 'Configuracion General'}
        Parameters: [KeyName, DBPassword]
      - Label: {default: 'Auto Scaling WordPress'}
        Parameters: [WordPressMinSize, WordPressMaxSize]
      - Label: {default: 'VPN WireGuard Opcional'}
        Parameters: [WireGuardServerPublicKey, WireGuardPeerEndpoint]

Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Default: vockey
    Description: Par de claves SSH para acceso a instancias

  DBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Default: Racing2026
    Description: Contrasena para RDS MariaDB y Zabbix

  WordPressMinSize:
    Type: Number
    Default: 2
    MinValue: 1
    MaxValue: 4
    Description: Numero minimo de instancias WordPress en ASG

  WordPressMaxSize:
    Type: Number
    Default: 4
    MinValue: 2
    MaxValue: 10
    Description: Numero maximo de instancias WordPress en ASG

  WireGuardServerPublicKey:
    Type: String
    Default: "PLACEHOLDER_PUBLIC_KEY"
    Description: Clave publica del servidor WireGuard fisico del estadio

  WireGuardPeerEndpoint:
    Type: String
    Default: "0.0.0.0:51820"
    Description: IP publica del servidor WireGuard fisico formato IP:PUERTO

Resources:

  # ==========================================================================
  # SECCION 1: RED VPC SUBNETS ROUTING
  # ==========================================================================

  RacingVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.200.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: Racing-VPC
        - Key: Proyecto
          Value: Racing-Santander

  RacingInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: Racing-IGW

  RacingIGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref RacingVPC
      InternetGatewayId: !Ref RacingInternetGateway

  RacingPublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RacingVPC
      CidrBlock: 10.200.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Racing-Public-Subnet-AZ1

  RacingPublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RacingVPC
      CidrBlock: 10.200.11.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Racing-Public-Subnet-AZ2

  RacingPrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RacingVPC
      CidrBlock: 10.200.20.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: Racing-Private-Subnet-AZ1

  RacingPrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RacingVPC
      CidrBlock: 10.200.21.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: Racing-Private-Subnet-AZ2

  RacingNATGatewayEIPA:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: Racing-NAT-EIP-AZ1

  RacingNATGatewayEIPB:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: Racing-NAT-EIP-AZ2

  RacingNATGatewayA:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt RacingNATGatewayEIPA.AllocationId
      SubnetId: !Ref RacingPublicSubnetA
      Tags:
        - Key: Name
          Value: Racing-NAT-Gateway-AZ1

  RacingNATGatewayB:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt RacingNATGatewayEIPB.AllocationId
      SubnetId: !Ref RacingPublicSubnetB
      Tags:
        - Key: Name
          Value: Racing-NAT-Gateway-AZ2

  RacingPublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-Public-RouteTable

  RacingPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: RacingIGWAttachment
    Properties:
      RouteTableId: !Ref RacingPublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref RacingInternetGateway

  RacingPublicSubnetARouteAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RacingPublicSubnetA
      RouteTableId: !Ref RacingPublicRouteTable

  RacingPublicSubnetBRouteAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RacingPublicSubnetB
      RouteTableId: !Ref RacingPublicRouteTable

  RacingPrivateRouteTableA:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-Private-RouteTable-AZ1

  RacingPrivateRouteTableB:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-Private-RouteTable-AZ2

  RacingPrivateRouteA:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RacingPrivateRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref RacingNATGatewayA

  RacingPrivateRouteB:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RacingPrivateRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref RacingNATGatewayB

  RacingPrivateSubnetARouteAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RacingPrivateSubnetA
      RouteTableId: !Ref RacingPrivateRouteTableA

  RacingPrivateSubnetBRouteAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RacingPrivateSubnetB
      RouteTableId: !Ref RacingPrivateRouteTableB

  # ==========================================================================
  # SECCION 2: SECURITY GROUPS
  # ==========================================================================

  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-LoadBalancer-SG
      GroupDescription: Permite HTTP publico al Load Balancer
      VpcId: !Ref RacingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP desde Internet
      Tags:
        - Key: Name
          Value: Racing-LoadBalancer-SG

  BastionSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-Bastion-SG
      GroupDescription: SSH WireGuard VPN y Nginx Reverse Proxy
      VpcId: !Ref RacingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: SSH desde Internet
        - IpProtocol: udp
          FromPort: 51820
          ToPort: 51820
          CidrIp: 0.0.0.0/0
          Description: WireGuard VPN desde terminales estadio
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP Nginx Reverse Proxy
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS Nginx Reverse Proxy futuro
      Tags:
        - Key: Name
          Value: Racing-Bastion-SG

  WordPressSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-WordPress-SG
      GroupDescription: Permite HTTP desde ALB SSH desde Bastion y NFS a EFS
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-WordPress-SG

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-Database-SG
      GroupDescription: MySQL desde WordPress Bastion y VPN
      VpcId: !Ref RacingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.200.20.0/23
          Description: MySQL desde subnets privadas WordPress
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: MySQL desde Bastion para administracion
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.200.99.0/24
          Description: MySQL desde red VPN WireGuard terminales
      Tags:
        - Key: Name
          Value: Racing-Database-SG

  EFSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-EFS-SG
      GroupDescription: NFS para EFS desde instancias WordPress
      VpcId: !Ref RacingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !Ref WordPressSecurityGroup
          Description: NFS desde WordPress para wp-content compartido
      Tags:
        - Key: Name
          Value: Racing-EFS-SG

  MonitoringSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-Monitoring-SG
      GroupDescription: Zabbix Server HTTP y agentes
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-Monitoring-SG

  WordPressIngressFromALB:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref WordPressSecurityGroup
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80
      SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup
      Description: HTTP solo desde Load Balancer

  WordPressIngressFromBastion:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref WordPressSecurityGroup
      IpProtocol: tcp
      FromPort: 22
      ToPort: 22
      SourceSecurityGroupId: !Ref BastionSecurityGroup
      Description: SSH solo desde Bastion

  MonitoringIngressHTTP:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref MonitoringSecurityGroup
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80
      SourceSecurityGroupId: !Ref BastionSecurityGroup
      Description: HTTP Zabbix Web desde Bastion

  MonitoringIngressSSH:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref MonitoringSecurityGroup
      IpProtocol: tcp
      FromPort: 22
      ToPort: 22
      SourceSecurityGroupId: !Ref BastionSecurityGroup
      Description: SSH desde Bastion

  MonitoringIngressZabbix:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref MonitoringSecurityGroup
      IpProtocol: tcp
      FromPort: 10051
      ToPort: 10051
      SourceSecurityGroupId: !Ref WordPressSecurityGroup
      Description: Zabbix Trapper desde WordPress

  LoadBalancerIngressFromBastion:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref LoadBalancerSecurityGroup
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80
      SourceSecurityGroupId: !Ref BastionSecurityGroup
      Description: HTTP desde Bastion Nginx hacia ALB WordPress

  # ==========================================================================
  # SECCION 3: EFS SISTEMA DE ARCHIVOS COMPARTIDO PARA WORDPRESS
  # ==========================================================================

  WordPressEFS:
    Type: AWS::EFS::FileSystem
    Properties:
      Encrypted: true
      PerformanceMode: generalPurpose
      ThroughputMode: bursting
      BackupPolicy:
        Status: ENABLED
      LifecyclePolicies:
        - TransitionToIA: AFTER_30_DAYS
      FileSystemTags:
        - Key: Name
          Value: Racing-WordPress-EFS
        - Key: Proyecto
          Value: Racing-Santander

  EFSMountTargetA:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref WordPressEFS
      SubnetId: !Ref RacingPrivateSubnetA
      SecurityGroups:
        - !Ref EFSSecurityGroup

  EFSMountTargetB:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref WordPressEFS
      SubnetId: !Ref RacingPrivateSubnetB
      SecurityGroups:
        - !Ref EFSSecurityGroup

  # ==========================================================================
  # SECCION 4: BASE DE DATOS RDS MARIADB MULTI-AZ
  # ==========================================================================

  RacingDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: racing-database-subnet-group
      DBSubnetGroupDescription: Subnets privadas para RDS Multi-AZ
      SubnetIds:
        - !Ref RacingPrivateSubnetA
        - !Ref RacingPrivateSubnetB
      Tags:
        - Key: Name
          Value: Racing-Database-SubnetGroup

  RacingMariaDBInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: racing-mariadb
      Engine: mariadb
      EngineVersion: "10.11"
      DBInstanceClass: db.t3.micro
      AllocatedStorage: 20
      StorageType: gp3
      MasterUsername: admin
      MasterUserPassword: !Ref DBPassword
      DBName: estadio_racing_bares
      DBSubnetGroupName: !Ref RacingDBSubnetGroup
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      PubliclyAccessible: false
      BackupRetentionPeriod: 7
      PreferredBackupWindow: "03:00-04:00"
      PreferredMaintenanceWindow: "sun:04:00-sun:05:00"
      MultiAZ: true
      CopyTagsToSnapshot: true
      Tags:
        - Key: Name
          Value: Racing-MariaDB-Instance
        - Key: Backup
          Value: Automated

  # ==========================================================================
  # SECCION 5: APPLICATION LOAD BALANCER
  # ==========================================================================

  RacingLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: Racing-ALB
      Type: application
      Scheme: internet-facing
      IpAddressType: ipv4
      Subnets:
        - !Ref RacingPublicSubnetA
        - !Ref RacingPublicSubnetB
      SecurityGroups:
        - !Ref LoadBalancerSecurityGroup
      Tags:
        - Key: Name
          Value: Racing-Application-LoadBalancer

  WordPressTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: Racing-WordPress-Targets
      VpcId: !Ref RacingVPC
      Protocol: HTTP
      Port: 80
      TargetType: instance
      HealthCheckEnabled: true
      HealthCheckProtocol: HTTP
      HealthCheckPath: /wp-admin/install.php
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: '200,301,302'
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: '30'
      Tags:
        - Key: Name
          Value: Racing-WordPress-TargetGroup

  LoadBalancerListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref RacingLoadBalancer
      Protocol: HTTP
      Port: 80
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref WordPressTargetGroup

  # ==========================================================================
  # SECCION 6: EC2 TEMPORAL PARA IMPORTAR SQL
  # ==========================================================================

  DatabaseLoaderInstance:
    Type: AWS::EC2::Instance
    DependsOn: RacingMariaDBInstance
    Properties:
      InstanceType: t3.micro
      ImageId: ami-0c7217cdde317cfec
      KeyName: !Ref KeyName
      SubnetId: !Ref RacingPrivateSubnetA
      SecurityGroupIds:
        - !Ref WordPressSecurityGroup
      IamInstanceProfile: LabInstanceProfile
      Tags:
        - Key: Name
          Value: Racing-DB-Loader-TEMP
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/db-import.log)
          exec 2>&1

          echo "[$(date)] Instalando MariaDB client..."
          dnf install -y mariadb105 wget

          echo "[$(date)] Esperando a que RDS este listo..."
          until mysql -h ${RacingMariaDBInstance.Endpoint.Address} -u admin -p${DBPassword} -e "SELECT 1;" > /dev/null 2>&1; do
            echo "RDS aun no responde. Reintentando en 10s..."
            sleep 10
          done

          echo "[$(date)] RDS ONLINE. Descargando SQL..."
          wget -O /tmp/estadio.sql https://raw.githubusercontent.com/sleuzau01/ASIR-Reto-Equipo3/main/estadio_racing_bares.sql

          echo "[$(date)] Importando SQL a RDS..."
          mysql -h ${RacingMariaDBInstance.Endpoint.Address} -u admin -p${DBPassword} < /tmp/estadio.sql

          echo "[$(date)] IMPORT COMPLETO. Verificando datos..."
          mysql -h ${RacingMariaDBInstance.Endpoint.Address} -u admin -p${DBPassword} -e "USE estadio_racing_bares; SELECT COUNT(*) AS total_bares FROM bares;"

          echo "[$(date)] SUCCESS. Apagando instancia en 60 segundos..."
          sleep 60
          shutdown -h now

  # ==========================================================================
  # SECCION 7: LAUNCH TEMPLATE WORDPRESS CON EFS
  # ==========================================================================

  WordPressLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    DependsOn:
      - RacingMariaDBInstance
      - DatabaseLoaderInstance
      - WordPressEFS
      - EFSMountTargetA
      - EFSMountTargetB
    Properties:
      LaunchTemplateName: Racing-WordPress-LaunchTemplate
      LaunchTemplateData:
        ImageId: ami-0c7217cdde317cfec
        InstanceType: t3.small
        KeyName: !Ref KeyName
        IamInstanceProfile:
          Name: LabInstanceProfile
        SecurityGroupIds:
          - !Ref WordPressSecurityGroup
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: Racing-WordPress-Instance
              - Key: ManagedBy
                Value: AutoScaling
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            set -e
            exec > >(tee /var/log/wordpress-setup.log)
            exec 2>&1

            echo "=== INSTALACION WORDPRESS + EFS RACING SANTANDER ===="
            echo "Timestamp: $(date)"

            echo "[1/12] Actualizando sistema..."
            dnf update -y

            echo "[2/12] Instalando Apache + PHP + MySQL + EFS Utils..."
            dnf install -y httpd php php-mysqlnd php-gd php-xml php-mbstring php-json wget awscli amazon-efs-utils

            echo "[3/12] Configurando PHP para uploads grandes..."
            sed -i 's/upload_max_filesize = 2M/upload_max_filesize = 512M/' /etc/php.ini
            sed -i 's/post_max_size = 8M/post_max_size = 512M/' /etc/php.ini
            sed -i 's/max_execution_time = 30/max_execution_time = 300/' /etc/php.ini
            sed -i 's/memory_limit = 128M/memory_limit = 256M/' /etc/php.ini

            echo "[4/12] Descargando WordPress..."
            cd /var/www/html
            wget -q https://wordpress.org/latest.tar.gz
            tar -xzf latest.tar.gz --strip-components=1
            rm latest.tar.gz

            echo "[5/12] Creando directorio temporal wp-content..."
            mkdir -p /tmp/wp-content-temp
            mv /var/www/html/wp-content/* /tmp/wp-content-temp/ 2>/dev/null || true
            rm -rf /var/www/html/wp-content

            echo "[6/12] Montando EFS en wp-content..."
            mkdir -p /var/www/html/wp-content
            echo "${WordPressEFS}.efs.${AWS::Region}.amazonaws.com:/ /var/www/html/wp-content nfs4 nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport,_netdev 0 0" >> /etc/fstab
            mount -a -t nfs4

            echo "[7/12] Restaurando archivos WordPress en EFS..."
            if [ "$(ls -A /var/www/html/wp-content)" ]; then
              echo "EFS ya contiene archivos. Saltando copia inicial."
            else
              echo "Primera instancia: Copiando wp-content a EFS..."
              cp -r /tmp/wp-content-temp/* /var/www/html/wp-content/
            fi
            rm -rf /tmp/wp-content-temp

            echo "[8/12] Obteniendo DNS del Load Balancer..."
            ALB_DNS=""
            for i in {1..20}; do
              ALB_DNS=$(aws elbv2 describe-load-balancers \
                --names Racing-ALB \
                --query 'LoadBalancers[0].DNSName' \
                --output text \
                --region ${AWS::Region} 2>/dev/null || echo "")
              if [[ -n "$ALB_DNS" && "$ALB_DNS" != "None" ]]; then
                echo "ALB DNS encontrado: $ALB_DNS"
                break
              fi
              echo "Intento $i/20 fallido. Reintentando en 10s..."
              sleep 10
            done

            if [[ -z "$ALB_DNS" || "$ALB_DNS" == "None" ]]; then
              ALB_DNS="racing-alb.${AWS::Region}.elb.amazonaws.com"
              echo "ADVERTENCIA: Usando DNS por defecto: $ALB_DNS"
            fi

            echo "[9/12] Creando wp-config.php..."
            cp wp-config-sample.php wp-config.php
            sed -i "s/database_name_here/estadio_racing_bares/" wp-config.php
            sed -i "s/username_here/admin/" wp-config.php
            sed -i "s/password_here/${DBPassword}/" wp-config.php
            sed -i "s/localhost/${RacingMariaDBInstance.Endpoint.Address}/" wp-config.php

            echo "[10/12] Configurando soporte para Load Balancer..."
            cat >> wp-config.php <<'WPCONF'
            /** CONFIGURACION LOAD BALANCER + REVERSE PROXY **/
            if (isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
              $_SERVER['HTTPS'] = 'on';
            }
            if (isset($_SERVER['HTTP_X_FORWARDED_HOST'])) {
              $_SERVER['HTTP_HOST'] = $_SERVER['HTTP_X_FORWARDED_HOST'];
            }
            WPCONF
            sed -i "/That's all, stop editing/i\\define('WP_HOME', 'http://$ALB_DNS');" wp-config.php
            sed -i "/That's all, stop editing/i\\define('WP_SITEURL', 'http://$ALB_DNS');" wp-config.php

            echo "[11/12] Ajustando permisos..."
            chown -R apache:apache /var/www/html
            chmod -R 755 /var/www/html
            find /var/www/html -type f -exec chmod 644 {} \;

            echo "[12/12] Configurando Apache..."
            echo "KeepAlive Off" >> /etc/httpd/conf/httpd.conf
            systemctl enable --now httpd
            systemctl status httpd

            echo "=== WORDPRESS + EFS INSTALADO CORRECTAMENTE ===="
            echo "EFS FileSystem: ${WordPressEFS}"
            echo "Timestamp: $(date)"

  # ==========================================================================
  # SECCION 8: AUTO SCALING GROUP
  # ==========================================================================

  WordPressAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    DependsOn:
      - RacingMariaDBInstance
      - DatabaseLoaderInstance
      - WordPressTargetGroup
      - WordPressEFS
    Properties:
      AutoScalingGroupName: Racing-WordPress-ASG
      VPCZoneIdentifier:
        - !Ref RacingPrivateSubnetA
        - !Ref RacingPrivateSubnetB
      LaunchTemplate:
        LaunchTemplateId: !Ref WordPressLaunchTemplate
        Version: !GetAtt WordPressLaunchTemplate.LatestVersionNumber
      MinSize: !Ref WordPressMinSize
      MaxSize: !Ref WordPressMaxSize
      DesiredCapacity: !Ref WordPressMinSize
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      TargetGroupARNs:
        - !Ref WordPressTargetGroup
      Tags:
        - Key: Name
          Value: Racing-WordPress-ASG-Instance
          PropagateAtLaunch: true
        - Key: Proyecto
          Value: Racing-Santander
          PropagateAtLaunch: true

  WordPressScalingPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref WordPressAutoScalingGroup
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization
        TargetValue: 70.0

  # ==========================================================================
  # SECCION 9: BASTION HOST VPN WIREGUARD + NGINX
  # ==========================================================================

  BastionVPNHost:
    Type: AWS::EC2::Instance
    DependsOn: RacingLoadBalancer
    Properties:
      InstanceType: t3.small
      ImageId: ami-0c7217cdde317cfec
      KeyName: !Ref KeyName
      SubnetId: !Ref RacingPublicSubnetA
      SecurityGroupIds:
        - !Ref BastionSecurityGroup
      IamInstanceProfile: LabInstanceProfile
      SourceDestCheck: false
      Tags:
        - Key: Name
          Value: Racing-Bastion-VPN-Nginx
        - Key: Rol
          Value: SSH-Jumpbox-VPN-ReverseProxy
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/bastion-setup.log)
          exec 2>&1

          echo "=== CONFIGURACION BASTION + VPN + NGINX REVERSE PROXY ==="
          echo "Timestamp: $(date)"

          echo "[1/9] Actualizando sistema..."
          dnf update -y

          echo "[2/9] Instalando herramientas + Nginx + WireGuard..."
          dnf install -y mysql telnet htop tcpdump nmap net-tools wget vim nginx wireguard-tools

          echo "[3/9] Generando claves WireGuard..."
          cd /etc/wireguard
          wg genkey | tee privatekey | wg pubkey > publickey
          chmod 600 privatekey
          PRIVATE_KEY=$(cat privatekey)
          PUBLIC_KEY=$(cat publickey)
          echo "Clave Publica WireGuard (compartir con servidor fisico):"
          echo "$PUBLIC_KEY"
          echo "$PUBLIC_KEY" > /tmp/wireguard-public-key.txt

          echo "[4/9] Creando configuracion WireGuard..."
          cat > /etc/wireguard/wg0.conf <<WGCONF
          [Interface]
          Address = 10.200.99.1/24
          ListenPort = 51820
          PrivateKey = $PRIVATE_KEY
          PostUp = sysctl -w net.ipv4.ip_forward=1
          PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
          PostUp = iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
          PostDown = iptables -D FORWARD -i wg0 -j ACCEPT
          PostDown = iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

          [Peer]
          PublicKey = ${WireGuardServerPublicKey}
          Endpoint = ${WireGuardPeerEndpoint}
          AllowedIPs = 10.200.99.0/24
          PersistentKeepalive = 25
          WGCONF
          chmod 600 /etc/wireguard/wg0.conf

          echo "[5/9] Habilitando IP Forwarding..."
          echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
          sysctl -p

          echo "[6/9] Iniciando WireGuard VPN..."
          systemctl enable wg-quick@wg0
          systemctl start wg-quick@wg0
          wg show

          echo "[7/9] Esperando DNS del Application Load Balancer..."
          ALB_DNS=""
          for i in {1..30}; do
            ALB_DNS=$(aws elbv2 describe-load-balancers \
              --names Racing-ALB \
              --query 'LoadBalancers[0].DNSName' \
              --output text \
              --region ${AWS::Region} 2>/dev/null || echo "")
            if [[ -n "$ALB_DNS" && "$ALB_DNS" != "None" ]]; then
              echo "ALB encontrado: $ALB_DNS"
              break
            fi
            echo "Intento $i/30... esperando 10s"
            sleep 10
          done

          if [[ -z "$ALB_DNS" || "$ALB_DNS" == "None" ]]; then
            echo "ERROR: No se pudo obtener DNS del ALB. Usando placeholder."
            ALB_DNS="racing-alb-placeholder.elb.amazonaws.com"
          fi

          echo "[8/9] Configurando Nginx como Reverse Proxy..."
          cat > /etc/nginx/conf.d/racing-proxy.conf <<'NGINXCONF'
          upstream wordpress_backend {
              server REPLACE_ALB_DNS:80 max_fails=3 fail_timeout=30s;
          }

          server {
              listen 80 default_server;
              server_name _;

              access_log /var/log/nginx/racing-access.log combined;
              error_log /var/log/nginx/racing-error.log warn;

              client_max_body_size 512M;
              client_body_buffer_size 128k;

              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_set_header X-Forwarded-Host $host;

              proxy_connect_timeout 60s;
              proxy_send_timeout 120s;
              proxy_read_timeout 120s;
              proxy_buffering off;

              location / {
                  proxy_pass http://wordpress_backend;
                  proxy_redirect off;
              }

              location /nginx_status {
                  stub_status on;
                  access_log off;
                  allow 127.0.0.1;
                  deny all;
              }

              location /health {
                  access_log off;
                  return 200 "Bastion Nginx OK\n";
                  add_header Content-Type text/plain;
              }
          }
          NGINXCONF

          sed -i "s/REPLACE_ALB_DNS/$ALB_DNS/g" /etc/nginx/conf.d/racing-proxy.conf

          rm -f /etc/nginx/nginx.conf.default
          rm -f /etc/nginx/conf.d/default.conf

          nginx -t

          echo "[9/9] Iniciando Nginx..."
          systemctl enable nginx
          systemctl start nginx
          systemctl status nginx

          PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)

          echo "=== BASTION CONFIGURADO CORRECTAMENTE ==="
          echo "- WireGuard VPN:    10.200.99.1 (puerto 51820 UDP)"
          echo "- Nginx Proxy HTTP: http://$PUBLIC_IP (puerto 80)"
          echo "- Backend ALB:      $ALB_DNS"
          echo "- SSH Access:       ssh ec2-user@$PUBLIC_IP"
          echo "Timestamp: $(date)"

  # ==========================================================================
  # SECCION 10: ZABBIX SERVER MONITOREO
  # ==========================================================================

  ZabbixMonitoringServer:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.medium
      ImageId: ami-0c7217cdde317cfec
      KeyName: !Ref KeyName
      SubnetId: !Ref RacingPrivateSubnetA
      SecurityGroupIds:
        - !Ref MonitoringSecurityGroup
      IamInstanceProfile: LabInstanceProfile
      Tags:
        - Key: Name
          Value: Racing-Zabbix-Server
        - Key: Rol
          Value: Monitoring
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/zabbix-setup.log)
          exec 2>&1

          echo "=== INSTALACION ZABBIX SERVER ==="
          rpm -Uvh https://repo.zabbix.com/zabbix/6.4/rhel/9/x86_64/zabbix-release-6.4-1.el9.noarch.rpm
          dnf clean all
          dnf install -y zabbix-server-mysql zabbix-web-mysql zabbix-apache-conf \
            zabbix-sql-scripts zabbix-selinux-policy zabbix-agent \
            mariadb-server mariadb

          systemctl enable --now mariadb

          mysql -e "CREATE DATABASE zabbix CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;"
          mysql -e "CREATE USER 'zabbix'@'localhost' IDENTIFIED BY '${DBPassword}';"
          mysql -e "GRANT ALL PRIVILEGES ON zabbix.* TO 'zabbix'@'localhost';"
          mysql -e "SET GLOBAL log_bin_trust_function_creators = 1;"

          zcat /usr/share/zabbix-sql-scripts/mysql/server.sql.gz | \
            mysql --default-character-set=utf8mb4 -uzabbix -p'${DBPassword}' zabbix

          mysql -e "SET GLOBAL log_bin_trust_function_creators = 0;"

          sed -i "s/# DBPassword=/DBPassword=${DBPassword}/" /etc/zabbix/zabbix_server.conf
          sed -i 's/^; php_value date.timezone.*/php_value date.timezone Europe\/Madrid/' /etc/php-fpm.d/zabbix.conf

          systemctl restart zabbix-server zabbix-agent httpd php-fpm
          systemctl enable zabbix-server zabbix-agent httpd php-fpm

          echo "=== ZABBIX INSTALADO CORRECTAMENTE ==="
          echo "Acceso Web: http://$(hostname -I | awk '{print $1}')/zabbix"
          echo "User: Admin / Pass: zabbix"

# ==========================================================================
# OUTPUTS INFORMACION POST-DESPLIEGUE
# ==========================================================================

Outputs:

  WebsiteURL:
    Description: URL PRINCIPAL - WordPress Racing Santander
    Value: !Sub "http://${RacingLoadBalancer.DNSName}"
    Export:
      Name: !Sub "${AWS::StackName}-Website-URL"

  WordPressAdminURL:
    Description: Panel de Administracion WordPress
    Value: !Sub "http://${RacingLoadBalancer.DNSName}/wp-admin"

  NginxProxyURL:
    Description: URL PUBLICA Nginx Reverse Proxy Bastion
    Value: !Sub "http://${BastionVPNHost.PublicIp}"
    Export:
      Name: !Sub "${AWS::StackName}-Nginx-Proxy-URL"

  BastionSSHCommand:
    Description: Comando SSH para conectar al Bastion
    Value: !Sub "ssh -i vockey.pem ec2-user@${BastionVPNHost.PublicIp}"

  WireGuardPublicKeyLocation:
    Description: Ubicacion de la Clave Publica WireGuard
    Value: "Ejecutar en Bastion: cat /tmp/wireguard-public-key.txt"

  DatabaseEndpoint:
    Description: Endpoint de la Base de Datos MariaDB
    Value: !GetAtt RacingMariaDBInstance.Endpoint.Address

  DatabaseConnectionCommand:
    Description: Comando para conectar a la Base de Datos desde Bastion
    Value: !Sub "mysql -h ${RacingMariaDBInstance.Endpoint.Address} -u admin -p${DBPassword} estadio_racing_bares"

  EFSFileSystemID:
    Description: ID del Sistema de Archivos EFS para wp-content
    Value: !Ref WordPressEFS
    Export:
      Name: !Sub "${AWS::StackName}-EFS-ID"

  EFSMountCommand:
    Description: Comando para montar EFS manualmente
    Value: !Sub "sudo mount -t nfs4 -o nfsvers=4.1 ${WordPressEFS}.efs.${AWS::Region}.amazonaws.com:/ /mnt/efs"

  ZabbixAccessTunnel:
    Description: Tunel SSH para acceder a Zabbix Web
    Value: !Sub "ssh -i vockey.pem -L 8080:${ZabbixMonitoringServer.PrivateIp}:80 ec2-user@${BastionVPNHost.PublicIp}"

  VPNNetworkInfo:
    Description: Red VPN WireGuard
    Value: "10.200.99.0/24 (AWS: 10.200.99.1, Clientes: 10.200.99.2-254)"

  AutoScalingGroupName:
    Description: Nombre del Auto Scaling Group de WordPress
    Value: !Ref WordPressAutoScalingGroup
