AWSTemplateFormatVersion: '2010-09-09'
Description: |
  Racing Santander - Infraestructura de Alta Disponibilidad
  Componentes: ALB + Auto Scaling WordPress + RDS Multi-AZ + VPN WireGuard + Zabbix
  Compatible con AWS Academy Lab


Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label: {default: 'Configuracion General'}
        Parameters: [KeyName, DBPassword]
      - Label: {default: 'Auto Scaling WordPress'}
        Parameters: [WordPressMinSize, WordPressMaxSize]
      - Label: {default: 'VPN WireGuard Opcional'}
        Parameters: [WireGuardServerPublicKey, WireGuardPeerEndpoint]


Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Default: vockey
    Description: Par de claves SSH para acceso a instancias


  DBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Default: Racing2026
    Description: Contrasena para RDS MariaDB y Zabbix


  WordPressMinSize:
    Type: Number
    Default: 2
    MinValue: 1
    MaxValue: 4
    Description: Numero minimo de instancias WordPress en ASG


  WordPressMaxSize:
    Type: Number
    Default: 4
    MinValue: 2
    MaxValue: 10
    Description: Numero maximo de instancias WordPress en ASG


  WireGuardServerPublicKey:
    Type: String
    Default: "PLACEHOLDER_PUBLIC_KEY"
    Description: Clave publica del servidor WireGuard fisico del estadio


  WireGuardPeerEndpoint:
    Type: String
    Default: "0.0.0.0:51820"
    Description: IP publica del servidor WireGuard fisico formato IP:PUERTO



Resources:
  # ==========================================================================
  # SECCION 1: RED VPC SUBNETS ROUTING
  # ==========================================================================


  RacingVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.200.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: Racing-VPC
        - Key: Proyecto
          Value: Racing-Santander


  RacingInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: Racing-IGW


  RacingIGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref RacingVPC
      InternetGatewayId: !Ref RacingInternetGateway


  # --- SUBNETS PUBLICAS Load Balancer Bastion ---
  RacingPublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RacingVPC
      CidrBlock: 10.200.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Racing-Public-Subnet-AZ1


  RacingPublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RacingVPC
      CidrBlock: 10.200.11.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Racing-Public-Subnet-AZ2


  # --- SUBNETS PRIVADAS WordPress RDS Zabbix ---
  RacingPrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RacingVPC
      CidrBlock: 10.200.20.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: Racing-Private-Subnet-AZ1


  RacingPrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RacingVPC
      CidrBlock: 10.200.21.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: Racing-Private-Subnet-AZ2


  # --- NAT GATEWAYS Alta Disponibilidad ---
  RacingNATGatewayEIPA:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: Racing-NAT-EIP-AZ1


  RacingNATGatewayEIPB:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: Racing-NAT-EIP-AZ2


  RacingNATGatewayA:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt RacingNATGatewayEIPA.AllocationId
      SubnetId: !Ref RacingPublicSubnetA
      Tags:
        - Key: Name
          Value: Racing-NAT-Gateway-AZ1


  RacingNATGatewayB:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt RacingNATGatewayEIPB.AllocationId
      SubnetId: !Ref RacingPublicSubnetB
      Tags:
        - Key: Name
          Value: Racing-NAT-Gateway-AZ2


  # --- TABLAS DE RUTAS ---
  RacingPublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-Public-RouteTable


  RacingPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: RacingIGWAttachment
    Properties:
      RouteTableId: !Ref RacingPublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref RacingInternetGateway


  RacingPublicSubnetARouteAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RacingPublicSubnetA
      RouteTableId: !Ref RacingPublicRouteTable


  RacingPublicSubnetBRouteAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RacingPublicSubnetB
      RouteTableId: !Ref RacingPublicRouteTable


  RacingPrivateRouteTableA:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-Private-RouteTable-AZ1


  RacingPrivateRouteTableB:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-Private-RouteTable-AZ2


  RacingPrivateRouteA:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RacingPrivateRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref RacingNATGatewayA


  RacingPrivateRouteB:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RacingPrivateRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref RacingNATGatewayB


  RacingPrivateSubnetARouteAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RacingPrivateSubnetA
      RouteTableId: !Ref RacingPrivateRouteTableA


  RacingPrivateSubnetBRouteAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RacingPrivateSubnetB
      RouteTableId: !Ref RacingPrivateRouteTableB



  # ==========================================================================
  # SECCION 2: SECURITY GROUPS SIN CARACTERES ESPECIALES
  # ==========================================================================


  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-LoadBalancer-SG
      GroupDescription: Permite HTTP publico al Load Balancer
      VpcId: !Ref RacingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP desde Internet
      Tags:
        - Key: Name
          Value: Racing-LoadBalancer-SG


  BastionSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-Bastion-SG
      GroupDescription: SSH y WireGuard VPN para Bastion
      VpcId: !Ref RacingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: SSH desde Internet
        - IpProtocol: udp
          FromPort: 51820
          ToPort: 51820
          CidrIp: 0.0.0.0/0
          Description: WireGuard VPN desde terminales estadio
      Tags:
        - Key: Name
          Value: Racing-Bastion-SG


  WordPressSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-WordPress-SG
      GroupDescription: Permite HTTP desde ALB y SSH desde Bastion
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-WordPress-SG


  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-Database-SG
      GroupDescription: MySQL desde WordPress Bastion y VPN
      VpcId: !Ref RacingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.200.20.0/23
          Description: MySQL desde subnets privadas WordPress
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: MySQL desde Bastion para administracion
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.200.99.0/24
          Description: MySQL desde red VPN WireGuard terminales
      Tags:
        - Key: Name
          Value: Racing-Database-SG


  MonitoringSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Racing-Monitoring-SG
      GroupDescription: Zabbix Server HTTP y agentes
      VpcId: !Ref RacingVPC
      Tags:
        - Key: Name
          Value: Racing-Monitoring-SG


  # --- REGLAS DE INGRESO SEPARADAS Evitan referencias circulares ---
  WordPressIngressFromALB:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref WordPressSecurityGroup
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80
      SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup
      Description: HTTP solo desde Load Balancer


  WordPressIngressFromBastion:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref WordPressSecurityGroup
      IpProtocol: tcp
      FromPort: 22
      ToPort: 22
      SourceSecurityGroupId: !Ref BastionSecurityGroup
      Description: SSH solo desde Bastion


  MonitoringIngressHTTP:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref MonitoringSecurityGroup
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80
      SourceSecurityGroupId: !Ref BastionSecurityGroup
      Description: HTTP Zabbix Web desde Bastion


  MonitoringIngressSSH:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref MonitoringSecurityGroup
      IpProtocol: tcp
      FromPort: 22
      ToPort: 22
      SourceSecurityGroupId: !Ref BastionSecurityGroup
      Description: SSH desde Bastion


  MonitoringIngressZabbix:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref MonitoringSecurityGroup
      IpProtocol: tcp
      FromPort: 10051
      ToPort: 10051
      SourceSecurityGroupId: !Ref WordPressSecurityGroup
      Description: Zabbix Trapper desde WordPress



  # ==========================================================================
  # SECCION 3: BASE DE DATOS RDS MARIADB MULTI-AZ
  # ==========================================================================


  RacingDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: racing-database-subnet-group
      DBSubnetGroupDescription: Subnets privadas para RDS Multi-AZ
      SubnetIds:
        - !Ref RacingPrivateSubnetA
        - !Ref RacingPrivateSubnetB
      Tags:
        - Key: Name
          Value: Racing-Database-SubnetGroup


  RacingMariaDBInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: racing-mariadb
      Engine: mariadb
      EngineVersion: "10.11"
      DBInstanceClass: db.t3.micro
      AllocatedStorage: 20
      StorageType: gp3
      MasterUsername: admin
      MasterUserPassword: !Ref DBPassword
      DBName: estadio_racing_bares
      DBSubnetGroupName: !Ref RacingDBSubnetGroup
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      PubliclyAccessible: false
      BackupRetentionPeriod: 7
      PreferredBackupWindow: "03:00-04:00"
      PreferredMaintenanceWindow: "sun:04:00-sun:05:00"
      MultiAZ: true
      CopyTagsToSnapshot: true
      Tags:
        - Key: Name
          Value: Racing-MariaDB-Instance
        - Key: Backup
          Value: Automated



  # ==========================================================================
  # SECCION 4: APPLICATION LOAD BALANCER
  # ==========================================================================


  RacingLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: Racing-ALB
      Type: application
      Scheme: internet-facing
      IpAddressType: ipv4
      Subnets:
        - !Ref RacingPublicSubnetA
        - !Ref RacingPublicSubnetB
      SecurityGroups:
        - !Ref LoadBalancerSecurityGroup
      Tags:
        - Key: Name
          Value: Racing-Application-LoadBalancer


  WordPressTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: Racing-WordPress-Targets
      VpcId: !Ref RacingVPC
      Protocol: HTTP
      Port: 80
      TargetType: instance
      HealthCheckEnabled: true
      HealthCheckProtocol: HTTP
      HealthCheckPath: /wp-admin/install.php
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: '200,301,302'
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: '30'
      Tags:
        - Key: Name
          Value: Racing-WordPress-TargetGroup


  LoadBalancerListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref RacingLoadBalancer
      Protocol: HTTP
      Port: 80
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref WordPressTargetGroup



  # ==========================================================================
  # SECCION 5: EC2 TEMPORAL PARA IMPORTAR SQL
  # ==========================================================================


  DatabaseLoaderInstance:
    Type: AWS::EC2::Instance
    DependsOn: RacingMariaDBInstance
    Properties:
      InstanceType: t3.micro
      ImageId: ami-0c7217cdde317cfec
      KeyName: !Ref KeyName
      SubnetId: !Ref RacingPrivateSubnetA
      SecurityGroupIds:
        - !Ref WordPressSecurityGroup
      IamInstanceProfile: LabInstanceProfile
      Tags:
        - Key: Name
          Value: Racing-DB-Loader-TEMP
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/db-import.log)
          exec 2>&1
          
          echo "[$(date)] Instalando MariaDB client..."
          dnf install -y mariadb105 wget
          
          echo "[$(date)] Esperando a que RDS este listo..."
          until mysql -h ${RacingMariaDBInstance.Endpoint.Address} -u admin -p${DBPassword} -e "SELECT 1;" > /dev/null 2>&1; do
            echo "RDS aun no responde. Reintentando en 10s..."
            sleep 10
          done
          
          echo "[$(date)] RDS ONLINE. Descargando SQL..."
          wget -O /tmp/estadio.sql https://raw.githubusercontent.com/sleuzau01/ASIR-Reto-Equipo3/main/estadio_racing_bares.sql
          
          echo "[$(date)] Importando SQL a RDS..."
          mysql -h ${RacingMariaDBInstance.Endpoint.Address} -u admin -p${DBPassword} < /tmp/estadio.sql
          
          echo "[$(date)] IMPORT COMPLETO. Verificando datos..."
          mysql -h ${RacingMariaDBInstance.Endpoint.Address} -u admin -p${DBPassword} -e "USE estadio_racing_bares; SELECT COUNT(*) AS total_bares FROM bares;"
          
          echo "[$(date)] SUCCESS. Apagando instancia en 60 segundos..."
          sleep 60
          shutdown -h now



  # ==========================================================================
  # SECCION 6: LAUNCH TEMPLATE PARA WORDPRESS
  # ==========================================================================


  WordPressLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    DependsOn:
      - RacingMariaDBInstance
      - DatabaseLoaderInstance
    Properties:
      LaunchTemplateName: Racing-WordPress-LaunchTemplate
      LaunchTemplateData:
        ImageId: ami-0c7217cdde317cfec
        InstanceType: t3.small
        KeyName: !Ref KeyName
        IamInstanceProfile:
          Name: LabInstanceProfile
        SecurityGroupIds:
          - !Ref WordPressSecurityGroup
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: Racing-WordPress-Instance
              - Key: ManagedBy
                Value: AutoScaling
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            set -e
            exec > >(tee /var/log/wordpress-setup.log)
            exec 2>&1
            
            echo "=== INSTALACION WORDPRESS RACING SANTANDER ==="
            echo "Timestamp: $(date)"
            
            echo "[1/10] Actualizando sistema..."
            dnf update -y
            
            echo "[2/10] Instalando Apache + PHP + MySQL..."
            dnf install -y httpd php php-mysqlnd php-gd php-xml php-mbstring php-json wget awscli
            
            echo "[3/10] Configurando PHP para uploads grandes..."
            sed -i 's/upload_max_filesize = 2M/upload_max_filesize = 512M/' /etc/php.ini
            sed -i 's/post_max_size = 8M/post_max_size = 512M/' /etc/php.ini
            sed -i 's/max_execution_time = 30/max_execution_time = 300/' /etc/php.ini
            sed -i 's/memory_limit = 128M/memory_limit = 256M/' /etc/php.ini
            
            echo "[4/10] Descargando WordPress..."
            cd /var/www/html
            wget -q https://wordpress.org/latest.tar.gz
            tar -xzf latest.tar.gz --strip-components=1
            rm latest.tar.gz
            
            echo "[5/10] Obteniendo DNS del Load Balancer..."
            ALB_DNS=""
            for i in {1..20}; do
              ALB_DNS=$(aws elbv2 describe-load-balancers \
                --names Racing-ALB \
                --query 'LoadBalancers[0].DNSName' \
                --output text \
                --region us-east-1 2>/dev/null || echo "")
              
              if [[ -n "$ALB_DNS" && "$ALB_DNS" != "None" ]]; then
                echo "ALB DNS encontrado: $ALB_DNS"
                break
              fi
              echo "Intento $i/20 fallido. Reintentando en 10s..."
              sleep 10
            done
            
            if [[ -z "$ALB_DNS" || "$ALB_DNS" == "None" ]]; then
              ALB_DNS="racing-alb.us-east-1.elb.amazonaws.com"
              echo "ADVERTENCIA: Usando DNS por defecto: $ALB_DNS"
            fi
            
            echo "[6/10] Creando wp-config.php..."
            cp wp-config-sample.php wp-config.php
            
            sed -i "s/database_name_here/estadio_racing_bares/" wp-config.php
            sed -i "s/username_here/admin/" wp-config.php
            sed -i "s/password_here/${DBPassword}/" wp-config.php
            sed -i "s/localhost/${RacingMariaDBInstance.Endpoint.Address}/" wp-config.php
            
            echo "[7/10] Configurando soporte para Load Balancer..."
            cat >> wp-config.php <<'WPCONF'
            
            /** CONFIGURACION LOAD BALANCER + REVERSE PROXY **/
            if (isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
                $_SERVER['HTTPS'] = 'on';
            }
            
            if (isset($_SERVER['HTTP_X_FORWARDED_HOST'])) {
                $_SERVER['HTTP_HOST'] = $_SERVER['HTTP_X_FORWARDED_HOST'];
            }
            WPCONF
            
            sed -i "/That's all, stop editing/i\define('WP_HOME', 'http://$ALB_DNS');" wp-config.php
            sed -i "/That's all, stop editing/i\define('WP_SITEURL', 'http://$ALB_DNS');" wp-config.php
            
            echo "[8/10] Configurando directorios para ASG..."
            mkdir -p /var/www/html/wp-content/uploads
            mkdir -p /var/www/html/wp-content/ai1wm-backups
            
            echo "[9/10] Ajustando permisos..."
            chown -R apache:apache /var/www/html
            chmod -R 755 /var/www/html
            find /var/www/html -type f -exec chmod 644 {} \;
            
            echo "[10/10] Configurando Apache..."
            echo "KeepAlive Off" >> /etc/httpd/conf/httpd.conf
            
            systemctl enable --now httpd
            systemctl status httpd
            
            echo "=== WORDPRESS INSTALADO CORRECTAMENTE ===" 
            echo "Timestamp: $(date)"



  # ==========================================================================
  # SECCION 7: AUTO SCALING GROUP
  # ==========================================================================


  WordPressAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    DependsOn:
      - RacingMariaDBInstance
      - DatabaseLoaderInstance
      - WordPressTargetGroup
    Properties:
      AutoScalingGroupName: Racing-WordPress-ASG
      VPCZoneIdentifier:
        - !Ref RacingPrivateSubnetA
        - !Ref RacingPrivateSubnetB
      LaunchTemplate:
        LaunchTemplateId: !Ref WordPressLaunchTemplate
        Version: !GetAtt WordPressLaunchTemplate.LatestVersionNumber
      MinSize: !Ref WordPressMinSize
      MaxSize: !Ref WordPressMaxSize
      DesiredCapacity: !Ref WordPressMinSize
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      TargetGroupARNs:
        - !Ref WordPressTargetGroup
      Tags:
        - Key: Name
          Value: Racing-WordPress-ASG-Instance
          PropagateAtLaunch: true
        - Key: Proyecto
          Value: Racing-Santander
          PropagateAtLaunch: true


  WordPressScalingPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref WordPressAutoScalingGroup
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization
        TargetValue: 70.0



  # ==========================================================================
  # SECCION 8: BASTION HOST VPN WIREGUARD
  # ==========================================================================


  BastionVPNHost:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.small
      ImageId: ami-0c7217cdde317cfec
      KeyName: !Ref KeyName
      SubnetId: !Ref RacingPublicSubnetA
      SecurityGroupIds:
        - !Ref BastionSecurityGroup
      IamInstanceProfile: LabInstanceProfile
      SourceDestCheck: false
      Tags:
        - Key: Name
          Value: Racing-Bastion-VPN
        - Key: Rol
          Value: SSH-Jumpbox-WireGuard-VPN
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/bastion-setup.log)
          exec 2>&1
          
          echo "=== CONFIGURACION BASTION + WIREGUARD VPN ==="
          echo "Timestamp: $(date)"
          
          echo "[1/6] Instalando herramientas administrativas..."
          dnf update -y
          dnf install -y mysql telnet htop tcpdump nmap net-tools wget vim
          
          echo "[2/6] Instalando WireGuard VPN..."
          dnf install -y wireguard-tools
          
          echo "[3/6] Generando claves WireGuard..."
          cd /etc/wireguard
          wg genkey | tee privatekey | wg pubkey > publickey
          chmod 600 privatekey
          
          PRIVATE_KEY=$(cat privatekey)
          PUBLIC_KEY=$(cat publickey)
          
          echo "Clave Publica WireGuard compartir con servidor fisico:"
          echo "$PUBLIC_KEY"
          echo "$PUBLIC_KEY" > /tmp/wireguard-public-key.txt
          
          echo "[4/6] Creando configuracion WireGuard..."
          cat > /etc/wireguard/wg0.conf <<WGCONF
          [Interface]
          Address = 10.200.99.1/24
          ListenPort = 51820
          PrivateKey = $PRIVATE_KEY
          
          PostUp = sysctl -w net.ipv4.ip_forward=1
          PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
          PostUp = iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
          PostDown = iptables -D FORWARD -i wg0 -j ACCEPT
          PostDown = iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
          
          [Peer]
          PublicKey = ${WireGuardServerPublicKey}
          Endpoint = ${WireGuardPeerEndpoint}
          AllowedIPs = 10.200.99.0/24
          PersistentKeepalive = 25
          WGCONF
          
          chmod 600 /etc/wireguard/wg0.conf
          
          echo "[5/6] Habilitando IP Forwarding..."
          echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
          sysctl -p
          
          echo "[6/6] Iniciando WireGuard VPN..."
          systemctl enable wg-quick@wg0
          systemctl start wg-quick@wg0
          
          wg show
          
          echo "=== BASTION + VPN CONFIGURADO ===" 
          echo "Clave publica WireGuard guardada en: /tmp/wireguard-public-key.txt"
          echo "Timestamp: $(date)"



  # ==========================================================================
  # SECCION 9: ZABBIX SERVER MONITOREO
  # ==========================================================================


  ZabbixMonitoringServer:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.medium
      ImageId: ami-0c7217cdde317cfec
      KeyName: !Ref KeyName
      SubnetId: !Ref RacingPrivateSubnetA
      SecurityGroupIds:
        - !Ref MonitoringSecurityGroup
      IamInstanceProfile: LabInstanceProfile
      Tags:
        - Key: Name
          Value: Racing-Zabbix-Server
        - Key: Rol
          Value: Monitoring
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/zabbix-setup.log)
          exec 2>&1
          
          echo "=== INSTALACION ZABBIX SERVER ==="
          
          rpm -Uvh https://repo.zabbix.com/zabbix/6.4/rhel/9/x86_64/zabbix-release-6.4-1.el9.noarch.rpm
          dnf clean all
          
          dnf install -y zabbix-server-mysql zabbix-web-mysql zabbix-apache-conf \
                         zabbix-sql-scripts zabbix-selinux-policy zabbix-agent \
                         mariadb-server mariadb
          
          systemctl enable --now mariadb
          
          mysql -e "CREATE DATABASE zabbix CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;"
          mysql -e "CREATE USER 'zabbix'@'localhost' IDENTIFIED BY '${DBPassword}';"
          mysql -e "GRANT ALL PRIVILEGES ON zabbix.* TO 'zabbix'@'localhost';"
          mysql -e "SET GLOBAL log_bin_trust_function_creators = 1;"
          
          zcat /usr/share/zabbix-sql-scripts/mysql/server.sql.gz | \
            mysql --default-character-set=utf8mb4 -uzabbix -p'${DBPassword}' zabbix
          
          mysql -e "SET GLOBAL log_bin_trust_function_creators = 0;"
          
          sed -i "s/# DBPassword=/DBPassword=${DBPassword}/" /etc/zabbix/zabbix_server.conf
          
          sed -i 's/^; php_value date.timezone.*/php_value date.timezone Europe\/Madrid/' /etc/php-fpm.d/zabbix.conf
          
          systemctl restart zabbix-server zabbix-agent httpd php-fpm
          systemctl enable zabbix-server zabbix-agent httpd php-fpm
          
          echo "=== ZABBIX INSTALADO CORRECTAMENTE ==="
          echo "Acceso Web: http://$(hostname -I | awk '{print $1}')/zabbix"
          echo "User: Admin / Pass: zabbix"



# ==========================================================================
# OUTPUTS INFORMACION POST-DESPLIEGUE
# ==========================================================================


Outputs:
  WebsiteURL:
    Description: URL PRINCIPAL - WordPress Racing Santander
    Value: !Sub "http://${RacingLoadBalancer.DNSName}"
    Export:
      Name: !Sub "${AWS::StackName}-Website-URL"


  WordPressAdminURL:
    Description: Panel de Administracion WordPress
    Value: !Sub "http://${RacingLoadBalancer.DNSName}/wp-admin"


  BastionSSHCommand:
    Description: Comando SSH para conectar al Bastion
    Value: !Sub "ssh -i vockey.pem ec2-user@${BastionVPNHost.PublicIp}"


  WireGuardPublicKeyLocation:
    Description: Ubicacion de la Clave Publica WireGuard
    Value: "Ejecutar en Bastion: cat /tmp/wireguard-public-key.txt"


  DatabaseEndpoint:
    Description: Endpoint de la Base de Datos MariaDB
    Value: !GetAtt RacingMariaDBInstance.Endpoint.Address


  DatabaseConnectionCommand:
    Description: Comando para conectar a la Base de Datos desde Bastion
    Value: !Sub "mysql -h ${RacingMariaDBInstance.Endpoint.Address} -u admin -p${DBPassword} estadio_racing_bares"


  ZabbixAccessTunnel:
    Description: Tunel SSH para acceder a Zabbix Web
    Value: !Sub "ssh -i vockey.pem -L 8080:${ZabbixMonitoringServer.PrivateIp}:80 ec2-user@${BastionVPNHost.PublicIp}"


  VPNNetworkInfo:
    Description: Red VPN WireGuard
    Value: "10.200.99.0/24 AWS: 10.200.99.1 Clientes: 10.200.99.2-254"


  AutoScalingGroupName:
    Description: Nombre del Auto Scaling Group de WordPress
    Value: !Ref WordPressAutoScalingGroup
